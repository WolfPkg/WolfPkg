#!/usr/bin/env php
<?php
declare(strict_types=1);

require_once __DIR__.'/../lib/autoconf.php';

\E\chdir($_ENV['WOLFPKG_ROOT']);

$rest = 0;
$opts = getopt('p:v:r', [], $rest);
$argv = array_slice($argv, max($rest, 1));

$package = '';
if (array_key_exists('p', $opts)) {
	$package = $opts['p'];
}
else {
	$package = $argv[0] ?? null;
	array_shift($argv);
}
$rev = null;
if (array_key_exists('v', $opts)) {
	$rev = $opts['v'];
}
else {
	$rev = $argv[0] ?? null;
	array_shift($argv);
}
$release = array_key_exists('r', $opts);

if (empty($package)) {
	echo "Must provide at least package name!\n";
	exit(-1);
}

$db = \Db\get_rw();

$exps = [];
$stm = $db->prepexec("SELECT p_id, p_name, p_chash, r_rev FROM packages NATURAL JOIN package_repo WHERE p_name = ?", [$package]);
while ($row = $stm->fetch()) {
	$exps[$row['p_name']] = $row;
}
if (empty($exps)) {
	printf("No such package '%s'!\n", $package);
	exit(-1);
}

$pkgs = \Pkg\enum_packages();
foreach ($pkgs as $path => $pkname) {
	if (empty($exps[$pkname])) {
		continue;
	}
	if ($pkname !== $package) {
		continue;
	}

	$cpath = "{$path}/pkg.json5";
	$conf = \Pkg\load_conf($cpath, $pkname);
	$conf['id'] = $exps[$pkname]['p_id'];
	$conf['chash'] = $exps[$pkname]['p_chash'];
	$rev = $rev ?? $exps[$pkname]['r_rev'];

	if (!$conf['enabled']) {
		printf("Package %s disabled!\n", $pkname);
		continue;
	}

	echo "Making tarball for {$pkname} @ {$rev}:\n";
	$rev = \Pkg\make_tarball($conf, $rev, $release);
	echo var_export($rev, true), "\n";
}
